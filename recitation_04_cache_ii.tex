\documentclass[aspectratio=169,12pt]{beamer}
\usepackage[utf8]{inputenc}
\usepackage{amsmath, amssymb}
\usepackage{booktabs}
\usepackage{colortbl}
\usepackage{hyperref}
\usepackage{makecell}
\usepackage{ragged2e}
\usepackage{bytefield}
\usepackage{tikz}
\usetikzlibrary{arrows.meta, positioning, shapes.geometric, calc, tikzmark, shapes.misc, fit, backgrounds}
\usepackage{tcolorbox}
\usetheme{Madrid}

\title{Computer Architecture}
\subtitle{Exercise 1: Performance Evaluation Parameters \& Amdahl's Law}
\author{Course 234267}
\date{}

\begin{document}

\frame{\titlepage}

\begin{frame}{Cache Coherence Flow}
\begin{tikzpicture}[
    scale=0.7, transform shape,
    box/.style={rectangle, draw, minimum width=1.5cm, minimum height=0.5cm},
    decision/.style={diamond, draw, aspect=2, inner sep=0pt, minimum width=1cm, fill=white},
    bluebox/.style={box, fill=blue!20},
    yellowbox/.style={box, fill=yellow},
    whitebox/.style={box, fill=white},
    every edge/.style={draw, ->, >=stealth},
    node distance=0.8cm and 1.5cm
]

% L1 Section
\node[bluebox] (l1) {L1};
\node[bluebox, below=0.3cm of l1] (l1read) {M: read miss};

\node[whitebox, below=of l1read] (snoopp1) {Snoop P};
\node[decision, below=of snoopp1] (dirty1) {P dirty?};
\node[bluebox, below=of dirty1] (inv1) {Invalidate P};
\begin{scope}[on background layer]
\node[fit=(snoopp1)(dirty1)(inv1), fill=yellow!30, draw=black, rounded corners, inner sep=5pt] (bg1) {};
\end{scope}
\node[yellowbox, below=1.5cm of inv1] (snoopx1) {Snoop X};

% L2 Section  
\node[bluebox, right=3cm of l1] (l2) {L2};
\node[bluebox, below=0.3cm of l2] (l2read) {M: read miss};

\node[whitebox, below=of l2read] (snoopp2) {Snoop P};
\node[decision, below=of snoopp2] (dirty2) {P dirty?};
\draw[->] (snoopp2) -- node[right] {\small HIT};
\node[bluebox, below=0.8cm of dirty2] (inv2) {Invalidate P};

\node[decision, below=0.5cm of inv2] (free) {Free entry?};
\node[yellowbox, below left=0.5cm and 0.3cm of free] (victimx) {victim: X};
\node[decision, below=0.5cm of victimx] (dirtyx) {dirty?};

% L3 Section
\node[bluebox, right=3cm of l2] (l3) {L3};
\node[bluebox, below=0.3cm of l3] (l3read) {M: read miss};

\node[bluebox, below=0.5cm of l3read] (select) {Select victim: P};
\node[yellowbox, below=0.5cm of select] (snoopp3) {Snoop P};
\node[decision, below=0.5cm of snoopp3] (dirty3) {P dirty?};
\node[bluebox, left=0.8cm of dirty3] (wrreq) {Yes: Wr Req};
\node[bluebox, below=0.8cm of dirty3] (inv3) {Invalidate P};
\node[bluebox, below=0.3cm of inv3] (update) {Update P};

% Arrows with labels
\draw[->] (l1read) -- node[above, sloped] {\small Rd Request} (l2read);
\draw[->] (l2read) -- node[above, sloped] {\small Rd Request} (l3read);
\draw[->] (l3read) -- node[above, sloped] {\small Rd Request} ++(5,0);

\draw[->] (snoopp1) -- (dirty1);
\draw[->] (dirty1) -- node[left] {\small no} (inv1);
\draw[thick, ->] (dirty1) -| (dirty2) node[right] {\small Yes: Wr Req};
\draw[->] (snoopp1) -- (dirty1) node[midway, right] {\small HIT};

\draw[->] (snoopp2) -- (dirty2);
\draw[->] (dirty2) -- node[left] {\small no} (inv2);
\draw[->] (dirty2) -- node[above] {\small Yes: Wr Req} ++(1,0);

\draw[->] (inv2) -- (free);
\draw[->] (free) -- node[above] {\small yes} ++(1,0);
\draw[->] (free) -- node[left] {\small no} (victimx);
\draw[->] (victimx) -- (dirtyx);

\draw[->] (select) edge[bend left=30, blue] node[above] {\small Snoop Request} (snoopp2.north);
\draw[->] (snoopp3) -- (dirty3);
\draw[->] (dirty3) -- node[left] {\small no} (inv3);
\draw[->] (dirty3) -- (wrreq);
\draw[->] (wrreq) -- node[above] {\small Yes: Wr Req} ++(-1,0);

% Bottom connections
%\draw[red, ->] (dirtyx) edge[bend right=40] node[below] {\small Fill M \& Update LRU} (snoopx1);
\draw[red, ->] (snoopx1) -- node[left] {\small Snoop + Fill M \& Update LRU} ++(-1.5,0);
\draw[red, ->] (victimx) edge[bend left] node[right] {\small Fill Data} ++(2.5,-1);
\draw[red, ->] (free) edge[bend right] node[below] {\small Fill M in P + Update LRU} ++(-2.5,0);

\end{tikzpicture}
\end{frame}

\end{document}