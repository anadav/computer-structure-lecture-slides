\documentclass[aspectratio=169,12pt]{beamer}
\usepackage[utf8]{inputenc}
\usepackage{amsmath, amssymb}
\usepackage{booktabs}
\usepackage{colortbl}
\usepackage{multirow}
\usepackage{hyperref}
\usepackage{makecell}
\usepackage{ragged2e}
\usepackage{tikz}
\usetikzlibrary{arrows.meta, positioning, shapes.geometric, calc, tikzmark, shapes.misc, fit, decorations.pathreplacing, matrix, backgrounds}
\usepackage{tcolorbox}
\usepackage{array}
\usepackage{listings}
\usepackage{pgfkeys}
\usepackage{adjustbox}
\usepackage[normalem]{ulem} 
\usetheme{Madrid}

\title{Out-of-Order Execution: Part III}
\subtitle{Example Problem}
\author{Computer Architecture 234267}
\date{2025, Recitation \#9}

\begin{document}

\begin{frame}[fragile, label=timeline-frame]
\frametitle{P6 $\mu$Architecture - Instruction Execution Timeline}

\begin{adjustbox}{width=\textwidth,center}
\footnotesize
\begin{tikzpicture}[remember picture, overlay,
    green circle/.style={green!70!black, very thick},
    red circle/.style={red!80!black, very thick},
    blue circle/.style={blue!70!black, very thick},
    arrow style/.style={->, thick, black}
]
% Circle positioning variables
\def\circlexshift{2mm}
\def\circleyshift{1mm}
% Green circles - can be revealed with \onslide
\onslide<15->{\draw[green circle] ([xshift=\circlexshift,yshift=\circleyshift] pic cs:green1addr) circle (9pt);}
\onslide<16->{\draw[green circle] ([xshift=\circlexshift,yshift=\circleyshift] pic cs:green2) circle (9pt);}
\onslide<17->{\draw[green circle] ([xshift=\circlexshift,yshift=\circleyshift] pic cs:green3) circle (9pt);}
\onslide<24->{\draw[green circle] ([xshift=3mm,yshift=\circleyshift] pic cs:red4) circle (12pt);}
% Red circle on address
\onslide<18->{\draw[red circle] ([xshift=\circlexshift,yshift=\circleyshift] pic cs:red1) circle (9pt);}
% Red circles around Std/Sta pairs
\onslide<19->{\draw[red circle] ([xshift=3mm,yshift=\circleyshift] pic cs:red2) circle (12pt);}
\onslide<20->{\draw[red circle] ([xshift=3mm,yshift=\circleyshift] pic cs:red3) circle (12pt);}
\onslide<21->{\draw[red circle] ([xshift=3mm,yshift=\circleyshift] pic cs:red4) circle (12pt);}
% Blue circle around T exe
\onslide<22->{\draw[blue circle] ([xshift=1mm,yshift=\circleyshift] pic cs:blue1) circle (9pt);}
% Arrow from 21 to 24 in T data ready column
\onslide<23->{\draw[arrow style, very thick] ([yshift=-2mm, xshift=2mm] pic cs:arrow1start) -- ([yshift=3mm, xshift=2mm] pic cs:arrow1end);}
\end{tikzpicture}
\begin{tabular}{|c|l|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|}
\hline
\multirow{2}{*}{\#} & \multirow{2}{*}{Instruction} & \multicolumn{3}{c|}{Reg Values} & \multicolumn{2}{c|}{Mem} & \multicolumn{10}{c|}{Execution Timeline} \\
\cline{3-17}
 & & R1 & R2 & R3 & addr & data & \rotatebox{90}{T alloc} & src1 & src2 & Imm & \rotatebox{90}{T src1 rdy} & \rotatebox{90}{T src2 rdy} & \rotatebox{90}{T exe} & \rotatebox{90}{Load block} & \rotatebox{90}{T data rdy} & \rotatebox{90}{T commit} \\
\hline
    \onslide<1->{0 & \texttt{ld R2=[R1+30]} & 10 & \underline{40} & 10 & 40 & 40} & \onslide<2->{1} & \onslide<2->{R1} & \onslide<2->{-} & \onslide<2->{30} & \onslide<3->{1} & \onslide<3->{-} & \onslide<4->{2} & \onslide<4->{\tiny ready} & \onslide<6->{11} & \onslide<7->{12} \\
    \onslide<1->{1 & \texttt{st [R2+20]=R1} & - & - & - & \tikzmark{green1addr}\underline{60} & 10} & \onslide<8->{1} & \onslide<8->{P0} & \onslide<8->{R1} & \onslide<8->{20} & \onslide<9->{11} & \onslide<9->{1} & \onslide<10->{\tikzmark{red2}\makecell{\tiny Std:2\\[-4pt]\tiny Sta:12}} & \onslide<10->{-} & \onslide<11->{12} & \onslide<12->{13} \\
    \onslide<1->{2 & \texttt{ld R3=[R1+100]} & - & - & \underline{110} & \underline{110} & 110} & & & & & & & & & & \\
    \onslide<1->{3 & \texttt{st [R1+40]=R3} & - & - & - & \tikzmark{green2}50 & 110} & & & & & & & & & & \\
    \onslide<1->{4 & \texttt{add R1=R1+10} & \underline{20} & - & - & - & -} & & & & & & & & & & \\
    \onslide<1->{5 & \texttt{blt (R1<100)} & 20 & 40 & 110 & - & -} & & & & & & & & & & \\
    \hline
    \onslide<1->{6 & \texttt{ld R2=[R1+30]} & - & \underline{110} & - & \underline{50} & 110} & & & & & & & & & & \\
    \onslide<1->{7 & \texttt{st [R2+20]=R1} & - & - & - & \tikzmark{green3}130 & 20} & & & & & & & & & & \\
    \onslide<1->{8 & \texttt{ld R3=[R1+100]} & - & - & \underline{120} & \tikzmark{red1}120 & 120} & & & & & & & & & & \\
    \onslide<1->{9 & \texttt{st [R1+40]=R3} & - & - & - & 60 & 120} & & & & & & & & & & \\
    \onslide<1->{10 & \texttt{add R1=R1+10} & \underline{30} & - & - & - & -} & & & & & & & & & & \\
    \onslide<1->{11 & \texttt{blt (R1<100)} & 30 & 110 & 120 & - & -} & & & & & & & & & & \\
    \hline
\end{tabular}
\end{adjustbox}

% Blue overlay for slides 5-7 (drawn after table so it appears on top)
\onslide<5-7>{
\begin{tikzpicture}[remember picture, overlay,
    node distance=6mm,
    bluecircle/.style={circle, draw=blue!70, fill=blue!70, fill opacity=1, text=white, 
                       minimum width=1.2cm, minimum height=0.8cm, font=\bfseries\scriptsize},
    bluerect/.style={rectangle, draw=blue!70, fill=blue!70, fill opacity=1, text=white, 
                     font=\bfseries, minimum width=1.5cm, minimum height=0.8cm},
    label/.style={blue!90!black, text width=2cm, align=center, fill=white, fill opacity=1}
]
    % Yellow background first (in front of underlying text, behind pipeline elements)
    \node[fill=yellow!30, fill opacity=1, draw=yellow!50, line width=1pt, minimum width=12cm, minimum height=5cm, rounded corners=5mm] at (current page.center) {};
    
    % Main nodes
    \node[bluecircle] at ([xshift=-3cm] current page.center) (n1) {1};
    \node[bluecircle, right=of n1] (n2) {2};
    \node[bluecircle, right=of n2] (n3) {3};
    \node[bluecircle, right=of n3] (n4) {4};
    
    % Dots
    \node[right=of n4] (dots) {\textcolor{blue!80!black}{$\bullet$ $\bullet$ $\bullet$}};
    
    % Node 10
    \node[bluecircle, right=of dots] (n10) {10};
    
    % Labels below nodes
    \node[label, below=2mm of n1] (l1) {Addr.\\ calculation};
    \node[label, below=2mm of n2] (l2) {Memory\\ checks};
    \node[label, below=2mm of n10] (l3) {L2 Hit};
    \node[bluerect, left=of l1] (load) {Load};
    
    % Arrow with "7 cycles" label
    \draw[<->, thick, blue!80!black] 
        ([yshift=-1.5cm]n4.south west) -- node[below] (clabel) {7 cycles} 
        ([yshift=-1.5cm]n10.east |- n4.south west);
\end{tikzpicture}
}

\vspace{0.3cm}
\onslide<14->{
\begin{columns}[T]
\begin{column}{0.48\textwidth}
\scriptsize
\textbf{Register Renaming:}
\begin{itemize}
\item Pi: Physical register i
\item Ri: Architectural register i
\end{itemize}
\end{column}
    \begin{column}{0.48\textwidth}
    \scriptsize
    \textbf{Store Load Block Codes:}
        \begin{itemize}
        \item 0: ready
        \item 1: address blocking
        \item 2: data not ready
        \end{itemize}
    \end{column}
\end{columns}
}
\end{frame}

% Againframe to continue without overlay
\againframe<8->{timeline-frame}


\end{document}